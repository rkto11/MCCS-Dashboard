<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>MCCS PPBEA</title>
    <link rel="stylesheet" href="./style.css" type="text/css"/>
    <link rel="stylesheet" href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css">  
    
    <script src="./js/chart.umd.js"></script>
    <script src="./js/datalabels-2.2.js"></script>
    <script src="./js/chartjs-chart-treemap.min.js"></script>
    
    <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
    <script src="./js/jquery-ui.min.js"></script>
    <script  src="./js/jquery.csv.js"></script>
    <link rel="stylesheet" type="text/css" href="./css/jquery-ui.structure.min.css">
	
    <link rel="stylesheet" type="text/css" href="./css/datatables.min.css"/>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <script src="./js/datatables.min.js"></script>
	<script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
	<script src="https://cdn.datatables.net/buttons/2.3.2/js/dataTables.buttons.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
	<script src="https://cdn.datatables.net/buttons/2.3.2/js/buttons.html5.min.js"></script>
	<script src="https://cdn.datatables.net/buttons/2.3.2/js/buttons.print.min.js"></script>
    
    <script src="./js/dataprocess.js"></script>
    <script src="./js/dataprocess-new.js"></script>
    <script src="./js/createtable-new.js"></script>
    <script src="./js/stackbar.js"></script>
    
</head>

<body>
    <div class="sidebar sidebar--isHidden noprint">
        <div class="sidebar-brand sidebar-brand--isHidden">
            <h2><img src="./img/icons8-marine-corps-500-white.png" `width="30px" height="30px" alt=""><span>MCCS</span></h2>
        </div>
        <div class="sidebar-menu sidebar-menu--isHidden">
            <ul>
                <li class="tabsButton tabsButton--active" data-for-tab="1">
                    <a onclick="toTop()"><span class="las la-home"></span>
                        <span>Home</span></a>
                </li>
                
                <li class="tabsButton" data-for-tab="2">
                    <a onclick="toTop()"><span class="las la-clipboard-list"></span>
                        <span>MCCS</span></a>
                </li>

                <li class="tabsButton" data-for-tab="3">
                    <a onclick="toTop()"><span class="las la-hotel"></span>
                        <span>MCHS</span></a>
                </li>
                
                <li class="tabsButton" data-for-tab="4">
                    <a onclick="toTop()"><span class="las la-dollar-sign"></span>
                        <span>Profit vs Util</span></a>
                </li>

                <li class="tabsButton" data-for-tab="5">
                    <a onclick="toTop()"><span class="las la-exclamation-triangle"></span>
                        <span>Q-Rating</span></a>
                </li>

                <li class="tabsButton" data-for-tab="6">
                    <a onclick="toTop()"><span class="las la-tree"></span>
                        <span>Treemap</span></a>
                </li>

                <li class="tabsButton" data-for-tab="7">
                    <a onclick="toTop()"><span class="las la-upload"></span>
                        <span>Upload</span></a>
                </li>
            </ul>
        </div>
    </div>

    <div class="main-content" id="main">
        <header class="noprint">
            <div class="header-title">
                <div id="toggle">
                    <h2>
                        <span class="las la-bars"></span> MCCS PPBEA
                    </h2>
                </div>
            </div>

            <div class="search-wrapper">
                <span class="las la-search"></span>
                <input type="search" placeholder="Search Here" />
            </div>
    
        </header>

        <main class="tab-content fade">
            <div class="content home-content content--active" data-tab="1">
                <div class="container-fluid" >
					<img src="./img/16_MCCSlogo_Comp.png" class="img-fluid" alt="MCCS Logo" style="max-height: 300px; display: block; margin-left: auto; margin-right: auto;">
					<h1>PPBEA Reform</h1>
				</div>

				<h2 id="introduction">INTRODUCTION</h2>
				<p>Over the last two decades, our warfighters and their families have faced many challenges and made great sacrifices; yet they remain resilient and committed to supporting our Marine Corps. As the warfighters have remained faithful to the Corps, Marine Corps Community Services (MCCS) stayed faithful to them and the sacrifices they continue to make on a daily basis by supporting their success through a coordinated system of services across the MCCS portfolio. MCCS works diligently to enhance operational readiness, resilience, and total fitness for Marines and their families by routinely assessing needs and seeking innovative solutions to provide effective and relevant programs and services.</p>
				<p>This strategic report is intended to inform and advance the Marine Corps Community Services (MCCS) Planning, Programming, Budget, Execution, and Audit/Assessment (PPBEA) reforms and fiscal guidance. Other tactical plans will be developed to operationalize and align MCCS planning endeavors.</p>
				<h2 id="an-enduring-mccs-mission">AN ENDURING MCCS MISSION</h2>
				<p>MCCS’ enduring mission is to take care of our Marines, Sailors, and their families in order to support the Marine Corps’ overall readiness and warfighting mission. MCCS provides a comprehensive and effective support system - from recruitment through separation or retirement, which supports readiness, preparedness, fitness, health, and overall quality of life. MCCS capabilities are delivered through three critical areas:</p>
				<h3 id="marine-and-family-programs">Marine and Family Programs</h3>
				<p>Marine and Family Programs provides a comprehensive and effective support system which improves readiness, preparedness, fitness, health, and overall quality of life, from recruitment through separation/retirement. Well-established programs, such as Community Counseling and Family Advocacy, and new initiatives such as implementation of a prevention strategy across the fleet, demonstrate MCCS’ commitment to families is strong and MCCS continues to provide support for the unique stresses and challenges USMC families face throughout a Marine’s career.</p>
				<h3 id="semper-fit-and-recreation">Semper Fit and Recreation</h3>
				<p>Semper Fit and Recreation capabilities provide commanders with a team of fitness experts, health educators, and sports and recreation professionals. The Semper Fit and Recreation Program improves military readiness and effectiveness through comprehensive human performance, fitness, sports, health education, and recreation programs designed to increase lethality and operational readiness. Semper Fit promotes a positive culture that deters negative behaviors, improves quality of life and serves as a critical arm in the prevention continuum. Semper Fit and Recreation focuses on the health protection and health sustainment of warfighters and their family members by supporting an individual’s proactive and actionable approach to improving and maintaining physical, emotional, and psychological resiliency.</p>
				<h3 id="business-and-support-services">Business and Support Services</h3>
				<p>The Business and Support Services of MCCS is about supporting Mission, Marines and their families by Investing in Marines for Duty Home and Self. The Marine Corps is most successful when Marines and families are equipped with services and tools they need to meet an era of persistent conflict, natural disasters, world pandemics, and the challenges of day-to-day life in the 21st century. A Marine’s ability to prevail over future challenges will depend on the strength of our force, the strength of our families,and our ability to navigate the ever-challenging environment that comes with a military lifestyle. There is an inherent understanding that our Business relevancy is aligned with mission and Marines. Our business portfolio is twofold; to develop solutions to meet the ever-changing needs of Marines while providing critical resources to support important MWR programs. The Business Portfolio includes activities that meet daily needs of Marines and families to include the Marine Corps Exchange, Marine Marts, Uniform Support, Food and PCS/TDY Lodging. Additionally, it includes an array of recreational activities that provide well-being, morale and a healthy lifestyle during dwell time.</p>
				<p>The Business Portfolio also includes Support Services that provides Non-appropriated fund (NAF) Back office support across the total MCCS Enterprise, including Family Programs, Semper Fit and the Business Services. The consolidated back-office services include Information Technology, Human Resources, Finance and Accounting, Buying and Procurement, Training and Construction. Several innovative common support efficiency reforms are underway to include the stand-up of a Global Business Services center for NAF transactional accounting, and the standardization of common support across the MCCS enterprise as a precursor to developing a full cost of ownership model that is aligned to PPBEA reform. Business Strategies are focused on innovation and modernization efforts to maintain relevance with Marine and mission. The Marine Corps has been recognized for their forward leaning efforts to establish new service delivery models in order to disrupt old think and antiquated business behaviors.</p>
				<hr />
				<h2 id="overarching-goals">OVERARCHING GOALS</h2>
				<h3 id="focus-on-the-individual-marine-and-their-family.">Focus on the individual Marine and their family.</h3>
				<p>We will listen to the voice of Marines and their families through constant program evaluations and knee cap to knee cap conversations, and will adapt our programs and services to meet both their career and life events. We will stay attuned to environmental, market, and mission conditions that afford the best chance of remaining relevant and responsive to the demographics of our Corps.</p>
				<h3 id="unity-of-efforts-and-purpose-across-mccs-in-the-execution-of-prevention-activities.">Unity of efforts and purpose across MCCS in the execution of prevention activities.</h3>
				<p>Problematic behaviors continue to impact the Marine Corps and unit readiness. They impact our Marines and families and they can disrupt mission readiness and force lethality. MCCS must take additional steps to reduce problematic behaviors and promote positive behaviors and institutionalize conditions and attitudes that sustain progress and align prevention efforts across the Marine Corps.</p>
				<h3 id="build-multi-capable-and-adaptable-programs-and-services.">Build multi-capable and adaptable programs and services.</h3>
				<p>Our programs and services will be delivered through a synergistic and multi-capable model that is not impeded by boundaries and lack of collaboration. We will exploit the integrated characteristics of our organization, the skill set of our employees, and innovative approaches and technologies to deliver programs. We will develop and maintain a strategically relevant expeditionary and home-station capacity, with the freedom to maneuver, as required.</p>
				<h3 id="posture-to-better-counter-threats-in-complex-business-operating-environments.">Posture to better counter “Threats” in complex business operating environments.</h3>
				<p>We recognize that threats pose a significant impact and barrier to our ability to effectively serve Marines and their families. Once discovered, these barriers must be mitigated through continual process improvements and business re-engineering initiatives. As such, the organization will endeavor to meet established benchmarks, standards, and policies that are necessary to position the organization for success.</p>
				<h3 id="invigorate-partnerships-and-internal-and-external-relationships.">Invigorate Partnerships and Internal and External Relationships.</h3>
				<p>We will pursue internal and external strategic partnerships designed to enhance our current capabilities, and improve access and availability of programs and services both on and off the installation. We will also build strong relationships with other service providers and work in unison to address and meet divergent needs and to partner for prevention.</p>
				<h3 id="expand-presence-and-communication.">Expand presence and communication.</h3>
				<p>The image of Marine Corps Community Services must be understood throughout the Marine Corps. Marketing and communication plans, as well as official Marine Corps awareness programs, will be implemented to aggressively promote programs and services in order to ensure that our message is ubiquitous throughout the Corps. Messaging will be multifaceted to meet the multigenerational communication needs of Marines and their Families.</p>
				<h3 id="become-a-critical-enabler-for-programs-and-services-to-support-marines-and-their-families.">Become a “Critical Enabler” for Programs and Services to support Marines and their Families.</h3>
				<p>We will be built on management principles, plans and policies that provide the necessary tools to effectively and efficiently deliver programs and services. Integrated training, technical assistance and enhanced communications will be used to implement and exploit best practices and lessons-learned</p>
				<hr />
				<h2 id="supporting-capabilities">SUPPORTING CAPABILITIES</h2>
				<h3 id="community-based-perspectives.">Community Based Perspectives.</h3>
				<p>Marines and their families are the centerpiece of the Corps and our MCCS programs. This is a team effort and dependent on quality, integrated relationships across all levels of command. Our support to Marines and families must be responsive and adaptive to the Fleet Marine Force and all commanders and organizations who are engaged in the development, education, health, and welfare of Marines and families.</p>
				<h3 id="building-program-excellence-and-an-innovation-culture.">Building Program Excellence and an Innovation Culture.</h3>
				<p>Our MCCS programs must address the unique challenges of the Marine Corps lifestyle. We expect excellence and nothing less. We continuously assess our programs so they provide a continuum of care throughout the Marines and families military lifecycle, addressing the balance of mission, life, and career events. We rapid prototype new business ventures and pilot test new services that are informed by in-depth research and leverage partnerships, sponsorships and technology to remain relevant in our mission contributions.</p>
				<h3 id="honing-the-warfighting-mindset.">Honing the Warfighting Mindset.</h3>
				<p>We develop programming and provide opportunities for Marine and families to develop readiness and resiliency skill sets. Enhancing their social relationships and support structures strengthen independence to navigate the military lifestyle when duty calls. Mind, body, spirit, and social are critical components of overall well-being and readiness.</p>
				<h3 id="funding-for-success">Funding for Success</h3>
				<p>We will be fiscally responsible and invest in readiness. We validate requirements and needs through a data driven approach. We plan, program, budget and execute resources to sustain valued programs and services and a well maintained infrastructure. MCCS BOD strategy and funding decisions are informed by strategic plans and a prioritization and risk management framework within the overarching MCCS PPBEA reform. We make hard decisions to prioritize resources to address the most important and relevant requirements. Likewise, we leverage the MCCS BOD and senior leaders to identify areas of divestiture.</p>
				<p>Reference: MCCS Integrated Strategic Guidance <a href="https://mccsorg-my.sharepoint.com/:b:/g/personal/jason_barnes_usmc-mccs_org/ESIbRg1PR9tMu8YLVtzJKkABncamySFqIZnTYB7Zv3bxQQ?e=ptuZJb">link</a></p>
            </div>

            <div class="content report-content" data-tab="2" id="mccs-report">
            </div>

            <div class="content MCHS-content" data-tab="3" id="mchs-report">
            </div>

            <div class="content UvP-content" data-tab="4">
                <div id="UtilProfContainer"></div>
            </div>

            <div class="content q-content" data-tab="5">
                <canvas id="stackbar" style="width: 100%;"></canvas>
                <button id="stackreset">BCI Reset</button>
                <button id="stackICIreset">ICI Reset</button>
                <br>
                <div id="barTableDiv">
                    <div id="barTabContainer">
                        <table id="tableBarData"></table>
                    </div>
                </div>
                <div id="qroverall"></div>
                
            </div>

            <div class="content exp-content" data-tab="6">
                <h2>MCCS Treemap</h2>

                <canvas id="tree" style="width: 100%;"></canvas>

                <!--Toggles here-->
                <button onclick="toggler('region')">Region</button>
                <button onclick="toggler('installation')">Installation</button>
                <button onclick="toggler('naf_cat')">NAF Category</button>
                <button onclick="toggler('op_activity')">Op Activity</button>
                <button onclick="toggler('fac_num')">Facility Number</button>
                <button onclick="toggler('use_desc')">Use Description</button>
                <button onclick="toggler('fci_q_rating')">FCI Q Rating</button>
                <br>
                <button onclick="toggleKey('FSRM')">FSRM</button>
                <button onclick="toggleKey('sus')">Sustainment</button>
                <button onclick="toggleKey('RM_corrected')">R&M</button>
                <button onclick="toggleKey('total_restoration')">Total Restoration</button>
                <button onclick="toggleKey('prv')">PRV</button>
                <button onclick="toggleKey('count')">Count</button>
                <br>
                <button onclick="toggleDataSource('Facilities')">Facilities</button>
                <button onclick="toggleDataSource('Utilizations')">Utilizations</button>
                <br>
                <button onclick="resetTree()">Reset</button>

                <p>Treemap is interactive. Click on tree leaf to "zoom in" to the next layer. The first row of buttons toggle the grouping of the leaves. Second row changes the dollar value of the groupings.</p>
                <div id="treemapTable">
                    <div id="tabContainer">
                        <table id="tableTreemap"></table>
                    </div>
                </div>

            </div>

            <div class="content upload-content" data-tab="7">
                <h3>Data Process</h3>
                <p>After pressing submit, please wait until progress bar on the bottom to turn green before proceeding.</p>
                <br>
                <label for="uploadfile">Choose GoRPM Export</label>
                <input type="file" id="uploadfile" name="uploadfile" accept=".xlsx, .xls">
                <br>
                <label for="FYSelect">Select FY for Report</label>
                <select id="FYSelect">
                    <option value="24">FY24</option>
                    <option value="25">FY25</option>
                    <option value="26">FY26</option>
                    <option value="27">FY27</option>
                    <option value="28">FY28</option>
                    <option value="29">FY29</option>
                    <option value="30">FY30</option>
                    <option value="31">FY31</option>
                    <option value="32">FY32</option>
                    <option value="33">FY33</option>
                    <option value="34">FY34</option>
                </select>
                <br>
                <label for="inflationinput">Inflation Factor per Year</label>
                <input type="number" id="inflationinput" step="0.001" value="1.077" maxlength="5" style="width: 75px; padding:  0rem 0.5rem;">
                <br>
                <button type="button" id="submitUpload">Submit</button>
                <br>
                <hr>
                <label for="uploadfile2">Choose Utilization vs Profit File</label>
                <input type="file" id="uploadfile2" name="uploadfile2" accept=".xlsx, .xls">
                <br>
                <button type="button" id="submitUpload2">Submit</button>

                <div id="Progress">
                    <div id="PB"></div>
                </div>
            </div>
        </main>
       
    </div>
</body>

<script>
    //Sidebar Hide/Unhide
    window.addEventListener("DOMContentLoaded", () => {
	    document.getElementById("toggle").addEventListener("click", () => {
		const sidebardiv = document.getElementsByClassName("sidebar")[0];
		sidebardiv.classList.toggle("sidebar--isHidden");
		const sidebarBrand = document.getElementsByClassName("sidebar-brand")[0];
        sidebarBrand.classList.toggle("sidebar-brand--isHidden");
        const sidebarMenu = document.getElementsByClassName("sidebar-menu")[0];
        sidebarMenu.classList.toggle("sidebar-menu--isHidden");
	    });
    });

    //Tab Content Selector
    function setupTabs() {
        document.querySelectorAll('.tabsButton').forEach(li => {
            li.addEventListener("click", () => {
                const sideBar = li.parentElement;
                const tabsContainer = document.querySelector('.tab-content');
                const tabNumber = li.dataset.forTab;
                const tabToActivate = tabsContainer.querySelector(`.content[data-tab="${tabNumber}"]`);

                sideBar.querySelectorAll('.tabsButton').forEach(li =>{
                    li.classList.remove('tabsButton--active');
                });

                tabsContainer.querySelectorAll(".content").forEach (tab => {
                    tab.classList.remove("content--active");
                });

                tabToActivate.classList.add("content--active");
                li.classList.add("tabsButton--active");
            });
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        setupTabs();
    });

    //Top function
    function toTop() {
        document.documentElement.scrollTop = 0;
    }

    //init treemap
    var treectx = document.getElementById("tree");
    var defaultconfig = {
        type: 'treemap',
        data: {
            datasets: [{
                label: 'FSRM',
                tree: [1]}]
            }
    };
    const myChart = new Chart(treectx, defaultconfig);
    
    //init stackbar
    var stackctx = document.getElementById("stackbar");
    const stackChart = new Chart(stackctx, {type: 'bar', labels:  "label", data: {datasets :[{label: "label", data: [1,2,3]}]}});

    //pull from uploaded data
    var selectedFile;
    var df_final;
    

    document
        .getElementById("uploadfile")
        .addEventListener("change", function(e) {
            selectedFile = e.target.files[0];
    });

    document
        .getElementById("submitUpload")
        .addEventListener("click", function() {
            if(selectedFile) {
                document.getElementById("PB").style.width = "100%";
                document.getElementById("PB").style.backgroundColor = "yellow";
                var fileReader = new FileReader();
                fileReader.onload = function(event) {
                    var data = event.target.result;
                    console.log("File Read");
                    var workbook = XLSX.read(data, {
                        type: "binary"
                    });

                    let FacSheet = XLSX.utils.sheet_to_row_object_array(workbook.Sheets["Facility"]);
                    let UtilSheet = XLSX.utils.sheet_to_row_object_array(workbook.Sheets["Utilization"]); 
                    let ICISheet = XLSX.utils.sheet_to_row_object_array(workbook.Sheets["Interior Condition Index"]);

                    df_final = goRPMProcess(FacSheet, UtilSheet, ICISheet);

                    CreateMCCSFSRMReport(df_final);
                    lowQRating(df_final);
                    document.getElementById("PB").style.backgroundColor = "green";
                    document.getElementById("PB").style.width = "100%";
                    
                    //treemap
                    clickThroughData = df_final[1];
                    initTree(df_final[1]); 

                    //stackbar
                    var stackFCIdata = stackdataprocess(df_final, 1);
                    stackInit(stackFCIdata, stackctx, stackChart);
                    const stackbutton = document.getElementById("stackreset");
                    stackbutton.addEventListener("click", function(){stackInit(stackFCIdata, stackctx, stackChart)});

                    var stackICIdata = stackdataprocess(df_final, 3);
                    const stackICIbutton = document.getElementById("stackICIreset");
                    stackICIbutton.addEventListener("click", function(){stackInit(stackICIdata, stackctx, stackChart)});

                };
                fileReader.readAsBinaryString(selectedFile); 
            }
        });

    
    //init treemap carryover variables
    var GROUPS = ["region"]; 
    var clickThroughData;
    var clickThroughLabel = "MCCS";
    var treeKey = "FSRM";
    
    function initTree(dataArray) {
        var treedatasets = [{
            label: "MCCS",
            tree: dataArray,
            key: treeKey,
            groups: GROUPS,
            borderWidth: 0,
            borderRadius: 6,
            spacing:1,
            backgroundColor: "rgba(3, 138, 255, 0.5)",
            labels: {
                align: 'left',
                display: true,
                formatter: (ctx) => [ctx.raw._data.label, '$' + (ctx.raw.v).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',')],
                color: ['white', 'whiteSmoke'],
                font: [{size: 14, weight: 'bold'}, {size: 12}],
                position: 'top'
            }
        }];

        var treeoptions =  {
            plugins: {
                title: {
                    display: true,
                    text: 'My treemap chart'
                },
                legend: {
                    display: true
                },
                tooltip: {
                    enabled: true,
                    callbacks: {
                        label(item) {
                            const dataItem = item.raw;
                            const obj = dataItem._data;
                            const label = obj.installation || obj.region || obj.op_activity || obj.fac_num || obj.use_desc;
                            return label + ': $' + dataItem.v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                        }
                    }
                } 
            }
        };

        myChart.data.datasets = treedatasets;
        myChart.data.options = treeoptions;
        myChart.update();

        function mousemoveHandler(ctx, mousemove) {
                const x = mousemove.offsetX;
                const y = mousemove.offsetY;
                //console.log(mousemove);
        }

        treectx.addEventListener('mousemove', (e) => {
                mousemoveHandler(myChart, e);
        });

        function clickHandler(click) {
            const bar = myChart.getElementsAtEventForMode(click, 'nearest', { interest: true }, true);
            const barindex = bar[0].index;
            const datapath = myChart.data.datasets[0].data[barindex]._data.path;
            var highestpath = datapath.split('.')[0];
            clickthrough(highestpath);
            //want to get to raw._data.path 
        }

        function clickthrough(path) {
            const highestGroup = GROUPS[0];
            //console.log(highestGroup + ' ' + path);
            var outputData = [];
            for(i=0; i<clickThroughData.length; i++) {
                if(clickThroughData[i][highestGroup] === path) {
                    outputData.push(clickThroughData[i]);
                }
            }
            
            if (GROUPS.length > 1 ) {
                GROUPS.shift();
            }

            else {
            if (highestGroup === 'region') {GROUPS = ['installation']; }
            if (highestGroup === 'installation') {GROUPS = ['naf_cat']; }
            if (highestGroup === 'naf_cat') {GROUPS = ['op_activity']; }
            if (highestGroup === 'op_activity') {GROUPS = ['use_desc']; }
            }

            clickThroughLabel += " / " + path;

            var labelformat = (ctx) => [ctx.raw._data.label, '$' + (ctx.raw.v).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',')];

            if (treeKey == "count") {
                labelformat = (ctx) => [ctx.raw._data.label, (ctx.raw.v).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',')];
            }

            var treedatasets = [{
                label: clickThroughLabel,
                tree: outputData,
                key: treeKey,
                groups: GROUPS,
                borderWidth: 0,
                borderRadius: 6,
                spacing:1,
                backgroundColor: "rgba(3, 138, 255, 0.5)",
                labels: {
                    align: 'left',
                    display: true,
                    formatter: labelformat,
                    color: ['white', 'whiteSmoke'],
                    font: [{size: 14, weight: 'bold'}, {size: 12}],
                    position: 'top'
                }
            }];

        clickThroughData = outputData;

        myChart.data.datasets = treedatasets;
        myChart.update();
        treeTableData(myChart.data.datasets[0].data, highestGroup);
    }

        treectx.onclick = clickHandler;
        treeTableData(myChart.data.datasets[0].data, "region");
    }

    function toggler(group) {
        const idx = GROUPS.indexOf(group);
        if (idx === -1) {
            GROUPS.push(group);
        } 
        else {
            GROUPS.splice(idx, 1);
        }
        myChart.config.data.datasets.groups = GROUPS;
        myChart.update();
        treeTableData(myChart.data.datasets[0].data, GROUPS[0]);
    }

    function toggleKey(key) {
        treeKey = key;

        var labelformat = (ctx) => [ctx.raw._data.label, '$' + (ctx.raw.v).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',')];

        if (treeKey == "count") {
            labelformat = (ctx) => [ctx.raw._data.label, (ctx.raw.v).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',')];
        }


        var treedatasets = [{
            label: clickThroughLabel,
            tree: clickThroughData,
            key: treeKey,
            groups: GROUPS,
            borderWidth: 0,
            borderRadius: 6,
            spacing:1,
            backgroundColor: "rgba(3, 138, 255, 0.5)",
            labels: {
                align: 'left',
                display: true,
                formatter: labelformat,
                color: ['white', 'whiteSmoke'],
                font: [{size: 14, weight: 'bold'}, {size: 12}],
                position: 'top'
            }
        }];
        myChart.data.datasets = treedatasets;
        myChart.update();
    }
    
    function toggleDataSource(datasetName) {
        var inputdata;
        if (datasetName ===  "Facilities") {
            inputdata = df_final[0];
            clickThroughLabel = "Facilities / MCCS";
        }
        else {
            inputdata = df_final[1];
            clickThroughLabel = "Utilizations / MCCS";
        }
        
        var treedatasets = [{
            label: clickThroughLabel,
            tree: inputdata,
            key: treeKey,
            groups: GROUPS,
            borderWidth: 0,
            borderRadius: 6,
            spacing:1,
            backgroundColor: "rgba(3, 138, 255, 0.5)",
            labels: {
                align: 'left',
                display: true,
                formatter: (ctx) => [ctx.raw._data.label, '$' + (ctx.raw.v).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',')],
                color: ['white', 'whiteSmoke'],
                font: [{size: 14, weight: 'bold'}, {size: 12}],
                position: 'top'
            }
        }];

        var treeoptions =  {
            plugins: {
                title: {
                    display: true,
                    text: 'My treemap chart'
                },
                legend: {
                    display: true
                },
                tooltip: {
                    enabled: true,
                    callbacks: {
                        label(item) {
                            const dataItem = item.raw;
                            const obj = dataItem._data;
                            const label = obj.installation || obj.region || obj.op_activity || obj.fac_num || obj.use_desc;
                            return label + ': $' + dataItem.v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                        }
                    }
                } 
            }
        };
        clickThroughData = inputdata;
        myChart.data.datasets = treedatasets;
        myChart.data.options = treeoptions;
        myChart.update();
        treeTableData(myChart.data.datasets[0].data, GROUPS[0]);
    }

    function resetTree() {
        GROUPS = ["region"];
        clickThroughData = df_final[1];
        clickThroughLabel = "MCCS";
        treeKey = "FSRM";
        initTree(df_final[1]);
    }

    function treeTableData(data, group) {
        //process data
        //console.log(data[0]._data);
        const grouping = GROUPS[0];
        var output = [];
        for (i=0; i<data.length; i++) {
            var sus = 0;
            var rm = 0;
            var fsrm = 0;
            var prv = 0;
            var q1 = 0;
            var q2 = 0;
            var q3 = 0;
            var q4 = 0;
            var count = 0;
            data[i]._data.children.forEach(e => {
                sus += e.sus;
                rm += e.RM_corrected;
                fsrm += e.FSRM;
                count += e.count;
                prv += e.prv;
                if(e.fci_q_rating === "Q1") {q1++};
                if(e.fci_q_rating === "Q2") {q2++};
                if(e.fci_q_rating === "Q3") {q3++};
                if(e.fci_q_rating === "Q4") {q4++};
            });
            
            const obj = {[grouping]: data[i].g};
            if(data[i].l == 0) {
            output.push({...obj, "Sustainment": sus, "RM": rm, "FSRM": fsrm, "PRV": prv, "Utilizations": count, "Q1": q1, "Q2": q2, "Q3": q3, "Q4": q4});
            }
        }


        //delete div then recreate
        document.getElementById("tabContainer").remove();   
        var newDiv = document.createElement('div');
        newDiv.id = "tabContainer";
        var newTable = document.createElement("table");
        newTable.id = "tableTreemap";
        newTable.className = "";
        newDiv.appendChild(newTable);

        document.getElementById("treemapTable").appendChild(newDiv);
        

        //create table
        var tablehtml = createTableHTML(output, 'Treemap');

        var numFormat = $.fn.dataTable.render.number('\,', '.', 0, '$' );
        var numFormat2 = $.fn.dataTable.render.number('\,', '.', 0);

        $(document).ready(function () {
        $('#tableTreemap').dataTable({
            data: output,
            dom: "Bfrtip",
            buttons: ['copy', 'csv', 'excel'],
            paging: true,
            "bLengthChange": false,
            "bFilter": true,
            "bInfo": false,
            order: [[3, 'desc']],
            columns: [
                {data: grouping},
                {data: 'Sustainment',render: numFormat},
                {data: 'RM',render: numFormat},
                {data: 'FSRM',render: numFormat},
                {data: 'PRV',render: numFormat},
                {data: 'Utilizations',render: numFormat2},
                {data: 'Q1',render: numFormat2},
                {data: 'Q2',render: numFormat2},
                {data: 'Q3',render: numFormat2},
                {data: 'Q4',render: numFormat2}
                
            ],
            
            "footerCallback": function ( row, data, start, end, display ) {
                var api = this.api();

                var intVal = function ( i ) {
                    return typeof i === 'string' ?
                        i.replace(/[\$,]/g, '')*1 :
                        typeof i === 'number' ?
                            i : 0;
                };

                $(api.column(0).footer()).html('Total');
                for(i=1; i<10; i++) {
                    var e = api.column(i).data().reduce(function(a,b){return intVal(a) +intVal(b);});
                    if(i < 5) {$(api.column(i).footer()).html(numFormat.display(e));}
                    else {$(api.column(i).footer()).html(numFormat2.display(e));}
                }
                
            }
        });
    });
    }


    //create functions to be called either here or in separate js file
    //chart js update prob needs to be created here
    //Util Prof Data Process
    var selectedFile2;
    document
        .getElementById("uploadfile2")
        .addEventListener("change", function(e) {
            selectedFile2 = e.target.files[0];
    });
    
    document
        .getElementById("submitUpload2")
        .addEventListener("click", function() {
            if(selectedFile2) {
                console.log("File Read");
                var fileReader = new FileReader();
                fileReader.onload = function(event) {
                    var data = event.target.result;
                    var workbook = XLSX.read(data, {
                        type: "binary"
                    });
                   
                    let UtilProf = XLSX.utils.sheet_to_row_object_array(workbook.Sheets["UtilProf"]);
                    processUtilProf(UtilProf);
                };
                fileReader.readAsBinaryString(selectedFile2);
            }
    });

</script>
</html>