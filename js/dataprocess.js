const InstNameConversionTable = [
    {
      "MCCS Installation Name": "M00146 MCAS CHERRY POINT NC",
      "Installation": "MCAS Cherry Point",
      "Region": "MCIEAST"
    },
    {
      "MCCS Installation Name": "M00243 MARCORPRCUITDEP SAN DIEGO CA",
      "Installation": "MCRD San Diego",
      "Region": "SLTI"
    },
    {
      "MCCS Installation Name": "M00263 MCRD BEAUFORT PI SC",
      "Installation": "MCRD PI",
      "Region": "MCIEAST"
    },
    {
      "MCCS Installation Name": "M00264 MARINE CORPS BASE QUANTICO VA",
      "Installation": "MCB Quantico",
      "Region": "MCINCR"
    },
    {
      "MCCS Installation Name": "M00318 MCB HAWAII KANEOHE",
      "Installation": "MCB Hawaii",
      "Region": "MCIPAC"
    },
    {
      "MCCS Installation Name": "M00681 MCB CAMP PENDLETON CA",
      "Installation": "MCB Pendleton",
      "Region": "MCIWEST"
    },
    {
      "MCCS Installation Name": "M09036 CAMP ALLEN",
      "Installation": "Camp Allen",
      "Region": "MCINCR"
    },
    {
      "MCCS Installation Name": "M20810 CAMP MUJUK REPUBLIC OF KOREA",
      "Installation": "Camp Mujuk",
      "Region": "MCIPAC"
    },
    {
      "MCCS Installation Name": "M60169 MCAS BEAUFORT SC",
      "Installation": "MCAS Beaufort",
      "Region": "MCIEAST"
    },
    {
      "MCCS Installation Name": "M62204 MCLB BARSTOW CA",
      "Installation": "MCLB Barstow",
      "Region": "MCIWEST"
    },
    {
      "MCCS Installation Name": "M62573 MCAS NEW RIVER JAX NC",
      "Installation": "MCAS New River",
      "Region": "MCIEAST"
    },
    {
      "MCCS Installation Name": "M62613 MCAS IWAKUNI JA",
      "Installation": "MCAS Iwakuni",
      "Region": "MCIPAC"
    },
    {
      "MCCS Installation Name": "M62974 MCAS YUMA AZ",
      "Installation": "MCAS Yuma",
      "Region": "MCIWEST"
    },
    {
      "MCCS Installation Name": "M64495 MARCORPSMWTC BRIDGEPORT CA",
      "Installation": "MWTC Bridgeport",
      "Region": "SLTI"
    },
    {
      "MCCS Installation Name": "M67001 MCB CAMP LEJEUNE NC",
      "Installation": "MCB Lejeune",
      "Region": "MCIEAST"
    },
    {
      "MCCS Installation Name": "M67004 MCLB ALBANY GA",
      "Installation": "MCLB Albany",
      "Region": "MCIEAST"
    },
    {
      "MCCS Installation Name": "M67011 MARCORPS DIST 1 GARDEN CITY NY",
      "Installation": "Garden City",
      "Region": "NONE"
    },
    {
      "MCCS Installation Name": "M67029 MARBKS WASHINGTON DC",
      "Installation": "MBW (8th & I)",
      "Region": "MCINCR"
    },
    {
      "MCCS Installation Name": "M67386 MCSPTACT KANSAS CITY MO",
      "Installation": "Kansas City",
      "Region": "NONE"
    },
    {
      "MCCS Installation Name": "M67399 MCAGCC TWENTYNINE PALMS CA",
      "Installation": "MCAGCC 29 Palms",
      "Region": "SLTI"
    },
    {
      "MCCS Installation Name": "M67400 MCB CAMP S D BUTLER OKINAWA JA",
      "Installation": "MCB Butler",
      "Region": "MCIPAC"
    },
    {
      "MCCS Installation Name": "M67695 MCSF BLOUNT ISLAND",
      "Installation": "MCSF Blount Island",
      "Region": "MCIEAST"
    },
    {
      "MCCS Installation Name": "M67861 MARCORRESFOR NEW ORLEANS LA",
      "Installation": "MARFORRES",
      "Region": "NONE"
    },
    {
      "MCCS Installation Name": "M67604 MCAS CAMP PENDLETON CA",
      "Installation": "MCAS Pendleton",
      "Region": "MCIWEST"
    },
    {
      "MCCS Installation Name": "M68479 HDQTRS 4TH MARDIV NEW ORLEANS",
      "Installation": "4th MARDIV",
      "Region": "NONE"
    },
    {
      "MCCS Installation Name": "M67865 MCAS MIRAMAR",
      "Installation": "MCAS Miramar",
      "Region": "MCIWEST"
    }
  ];

const CCNtoOpAct = [
  {
      "use_code": "12310",
      "op_activity": "Exchange Operations"
  },
  {
      "use_code": "12317",
      "op_activity": "Exchange Operations"
  },
  {
      "use_code": "12330",
      "op_activity": "Exchange Operations"
  },
  {
      "use_code": "17125",
      "op_activity": "Commercial Recreation"
  },
  {
      "use_code": "71432",
      "op_activity": "Marine & Family Programs"
  },
  {
      "use_code": "73013",
      "op_activity": "Exchange Operations"
  },
  {
      "use_code": "73074",
      "op_activity": "Other Business Operations"
  },
  {
      "use_code": "74001",
      "op_activity": "Exchange Operations"
  },
  {
      "use_code": "74003",
      "op_activity": "Exchange Operations"
  },
  {
      "use_code": "74004",
      "op_activity": "Food & Beverage (Direct)"
  },
  {
      "use_code": "74009",
      "op_activity": "Exchange Operations"
  },
  {
      "use_code": "74013",
      "op_activity": "Exchange Operations"
  },
  {
      "use_code": "74016",
      "op_activity": "Exchange Operations"
  },
  {
      "use_code": "74020",
      "op_activity": "PCS Lodging"
  },
  {
      "use_code": "74021",
      "op_activity": "Marine & Family Programs"
  },
  {
      "use_code": "74025",
      "op_activity": "Marine & Family Programs"
  },
  {
      "use_code": "74027",
      "op_activity": "Marine & Family Programs"
  },
  {
      "use_code": "74030",
      "op_activity": "Exchange Operations"
  },
  {
      "use_code": "74032",
      "op_activity": "Exchange Operations"
  },
  {
      "use_code": "74033",
      "op_activity": "Exchange Operations"
  },
  {
      "use_code": "74034",
      "op_activity": "Marine & Family Programs"
  },
  {
      "use_code": "74036",
      "op_activity": "Commercial Recreation"
  },
  {
      "use_code": "74037",
      "op_activity": "Commercial Recreation"
  },
  {
      "use_code": "74038",
      "op_activity": "Marine & Family Programs"
  },
  {
      "use_code": "74040",
      "op_activity": "Commercial Recreation"
  },
  {
      "use_code": "74042",
      "op_activity": "Semper Fit Programs"
  },
  {
      "use_code": "74044",
      "op_activity": "Semper Fit Programs"
  },
  {
      "use_code": "74045",
      "op_activity": "Semper Fit Programs"
  },
  {
      "use_code": "74046",
      "op_activity": "Commercial Recreation"
  },
  {
      "use_code": "74047",
      "op_activity": "Commercial Recreation"
  },
  {
      "use_code": "74053",
      "op_activity": "Semper Fit Programs"
  },
  {
      "use_code": "74055",
      "op_activity": "Children & Youth Programs"
  },
  {
      "use_code": "74056",
      "op_activity": "Commercial Recreation"
  },
  {
      "use_code": "74067",
      "op_activity": "Clubs"
  },
  {
      "use_code": "74068",
      "op_activity": "Clubs"
  },
  {
      "use_code": "74071",
      "op_activity": "Exchange Operations"
  },
  {
      "use_code": "74074",
      "op_activity": "Children & Youth Programs"
  },
  {
      "use_code": "74076",
      "op_activity": "Marine & Family Programs"
  },
  {
      "use_code": "74077",
      "op_activity": "Other Business Operations"
  },
  {
      "use_code": "74078",
      "op_activity": "Marine & Family Programs"
  },
  {
      "use_code": "74079",
      "op_activity": "Commercial Recreation"
  },
  {
      "use_code": "74080",
      "op_activity": "Commercial Recreation"
  },
  {
      "use_code": "74081",
      "op_activity": "Commercial Recreation"
  },
  {
      "use_code": "74085",
      "op_activity": "Exchange Operations"
  },
  {
      "use_code": "74086",
      "op_activity": "Exchange Operations"
  },
  {
      "use_code": "74087",
      "op_activity": "Commercial Recreation"
  },
  {
      "use_code": "74088",
      "op_activity": "Marine & Family Programs"
  },
  {
      "use_code": "74089",
      "op_activity": "Marine & Family Programs"
  },
  {
      "use_code": "74090",
      "op_activity": "Semper Fit Programs"
  },
  {
      "use_code": "74092",
      "op_activity": "Commercial Recreation"
  },
  {
      "use_code": "74093",
      "op_activity": "Marine & Family Programs"
  },
  {
      "use_code": "74094",
      "op_activity": "TDY Lodging"
  },
  {
      "use_code": "74095",
      "op_activity": "Marine & Family Programs"
  },
  {
      "use_code": "75010",
      "op_activity": "Semper Fit Programs"
  },
  {
      "use_code": "75020",
      "op_activity": "Semper Fit Programs"
  },
  {
      "use_code": "75021",
      "op_activity": "Commercial Recreation"
  },
  {
      "use_code": "75022",
      "op_activity": "Semper Fit Programs"
  },
  {
      "use_code": "75030",
      "op_activity": "Semper Fit Programs"
  },
  {
      "use_code": "75033",
      "op_activity": "Semper Fit Programs"
  },
  {
      "use_code": "75037",
      "op_activity": "Semper Fit Programs"
  },
  {
      "use_code": "75038",
      "op_activity": "Marine & Family Programs"
  },
  {
      "use_code": "75039",
      "op_activity": "Commercial Recreation"
  },
  {
      "use_code": "75040",
      "op_activity": "Commercial Recreation"
  },
  {
      "use_code": "75050",
      "op_activity": "Commercial Recreation"
  },
  {
      "use_code": "75052",
      "op_activity": "Commercial Recreation"
  },
  {
      "use_code": "75054",
      "op_activity": "Marine & Family Programs"
  },
  {
      "use_code": "75056",
      "op_activity": "Commercial Recreation"
  },
  {
      "use_code": "75057",
      "op_activity": "Marine & Family Programs"
  },
  {
      "use_code": "75059",
      "op_activity": "Commercial Recreation"
  },
  {
      "use_code": "75060",
      "op_activity": "Commercial Recreation"
  },
  {
      "use_code": "75061",
      "op_activity": "Commercial Recreation"
  },
  {
      "use_code": "75110",
      "op_activity": "Children & Youth Programs"
  }
];

const CCNNafCat = [
    {
        "use_code": "12315",
        "facility_desc": "Utility Building",
        "naf_cat": "C"
    },
    {
        "use_code": "12317",
        "facility_desc": "Overhead Cover",
        "naf_cat": "C"
    },
    {
        "use_code": "12330",
        "facility_desc": "Vehicle Operating Fuel Storage",
        "naf_cat": "C"
    },
    {
        "use_code": "12340",
        "facility_desc": "Vehicle Operating Fuel Storage",
        "naf_cat": "C"
    },
    {
        "use_code": "12350",
        "facility_desc": "Vehicle Operating Fuel Storage",
        "naf_cat": "C"
    },
    {
        "use_code": "17125",
        "facility_desc": "Auditorium and Theater Facility",
        "naf_cat": "B"
    },
    {
        "use_code": "71432",
        "facility_desc": "Community Activities/ Conference Center",
        "naf_cat": "A"
    },
    {
        "use_code": "73013",
        "facility_desc": "Clothing Sales Store",
        "naf_cat": "C"
    },
    {
        "use_code": "73074",
        "facility_desc": "Retail Kennel",
        "naf_cat": "C"
    },
    {
        "use_code": "74001",
        "facility_desc": "Exchange Sales Facility",
        "naf_cat": "C"
    },
    {
        "use_code": "74003",
        "facility_desc": "Exchange Support Facility",
        "naf_cat": "C"
    },
    {
        "use_code": "74004",
        "facility_desc": "Exchange Eating Facility",
        "naf_cat": "C"
    },
    {
        "use_code": "74009",
        "facility_desc": "Exchange Sales Facility",
        "naf_cat": "C"
    },
    {
        "use_code": "74013",
        "facility_desc": "Laundry/Dry Cleaning Facility",
        "naf_cat": "C"
    },
    {
        "use_code": "74016",
        "facility_desc": "Exchange Support Facility",
        "naf_cat": "C"
    },
    {
        "use_code": "74020",
        "facility_desc": "Transient  Lodging",
        "naf_cat": "L (PCS)"
    },
    {
        "use_code": "74021",
        "facility_desc": "Community Activities/ Conference Center",
        "naf_cat": "A"
    },
    {
        "use_code": "74025",
        "facility_desc": "Family Service Center",
        "naf_cat": "A"
    },
    {
        "use_code": "74027",
        "facility_desc": "Photo/TV Production Building",
        "naf_cat": "A"
    },
    {
        "use_code": "74030",
        "facility_desc": "Exchange Automobile Facility",
        "naf_cat": "C"
    },
    {
        "use_code": "74031",
        "facility_desc": "POV Filling Station",
        "naf_cat": "C"
    },
    {
        "use_code": "74032",
        "facility_desc": "Car Wash Facility",
        "naf_cat": "C"
    },
    {
        "use_code": "74033",
        "facility_desc": "Car Wash Structure",
        "naf_cat": "C"
    },
    {
        "use_code": "74034",
        "facility_desc": "Thrift Shop",
        "naf_cat": "B"
    },
    {
        "use_code": "74036",
        "facility_desc": "Hobby And Craft Center",
        "naf_cat": "B"
    },
    {
        "use_code": "74037",
        "facility_desc": "MWR Sales and Rental Building",
        "naf_cat": "B"
    },
    {
        "use_code": "74038",
        "facility_desc": "Automobile Craft Center",
        "naf_cat": "B"
    },
    {
        "use_code": "74040",
        "facility_desc": "Bowling Center",
        "naf_cat": "B"
    },
    {
        "use_code": "74042",
        "facility_desc": "Recreation Center",
        "naf_cat": "A"
    },
    {
        "use_code": "74044",
        "facility_desc": "Indoor Physical Fitness Facility",
        "naf_cat": "A"
    },
    {
        "use_code": "74045",
        "facility_desc": "Indoor Physical Fitness Facility",
        "naf_cat": "A"
    },
    {
        "use_code": "74046",
        "facility_desc": "Indoor Skating Rink",
        "naf_cat": "C"
    },
    {
        "use_code": "74047",
        "facility_desc": "MWR Sales and Rental Building",
        "naf_cat": "B"
    },
    {
        "use_code": "74049",
        "facility_desc": "Indoor Physical Fitness Facility",
        "naf_cat": "A"
    },
    {
        "use_code": "74053",
        "facility_desc": "Indoor Swimming Pool",
        "naf_cat": "B"
    },
    {
        "use_code": "74055",
        "facility_desc": "Recreation Center",
        "naf_cat": "B"
    },
    {
        "use_code": "74056",
        "facility_desc": "Auditorium and Theater Facility",
        "naf_cat": "B"
    },
    {
        "use_code": "74067",
        "facility_desc": "Open Mess and Club Facility",
        "naf_cat": "C"
    },
    {
        "use_code": "74068",
        "facility_desc": "Open Mess and Club Facility",
        "naf_cat": "C"
    },
    {
        "use_code": "74071",
        "facility_desc": "Exchange Sales Facility",
        "naf_cat": "C"
    },
    {
        "use_code": "74074",
        "facility_desc": "Nursery and Child Care Facility",
        "naf_cat": "B"
    },
    {
        "use_code": "74076",
        "facility_desc": "Library, General Use",
        "naf_cat": "A"
    },
    {
        "use_code": "74077",
        "facility_desc": "Covered Storage Building, Installation",
        "naf_cat": "B"
    },
    {
        "use_code": "74078",
        "facility_desc": "Pavilion",
        "naf_cat": "A"
    },
    {
        "use_code": "74079",
        "facility_desc": "Stable",
        "naf_cat": "C"
    },
    {
        "use_code": "74080",
        "facility_desc": "Golf Club House and Sales",
        "naf_cat": "C"
    },
    {
        "use_code": "74081",
        "facility_desc": "Recreational Lodging",
        "naf_cat": "C"
    },
    {
        "use_code": "74085",
        "facility_desc": "Exchange Warehouse",
        "naf_cat": "C"
    },
    {
        "use_code": "74086",
        "facility_desc": "Exchange Warehouse",
        "naf_cat": "C"
    },
    {
        "use_code": "74087",
        "facility_desc": "Boathouse",
        "naf_cat": "B"
    },
    {
        "use_code": "74088",
        "facility_desc": "Education Center",
        "naf_cat": "A"
    },
    {
        "use_code": "74089",
        "facility_desc": "Public Restroom/Shower",
        "naf_cat": "C"
    },
    {
        "use_code": "74090",
        "facility_desc": "Recreational Support Building",
        "naf_cat": "B"
    },
    {
        "use_code": "74092",
        "facility_desc": "Transient And Recreational Lodging Support Facility",
        "naf_cat": "C"
    },
    {
        "use_code": "74093",
        "facility_desc": "Personnel/ Equipment Shelter",
        "naf_cat": "A"
    },
    {
        "use_code": "74094",
        "facility_desc": "Transient  Lodging",
        "naf_cat": "L (TDY)"
    },
    {
        "use_code": "74095",
        "facility_desc": "Transient  Lodging",
        "naf_cat": "A"
    },
    {
        "use_code": "75010",
        "facility_desc": "Outdoor Playing Court",
        "naf_cat": "B"
    },
    {
        "use_code": "75020",
        "facility_desc": "Athletic Field",
        "naf_cat": "B"
    },
    {
        "use_code": "75021",
        "facility_desc": "Outdoor Playing Court",
        "naf_cat": "B"
    },
    {
        "use_code": "75022",
        "facility_desc": "Outdoor Running Track",
        "naf_cat": "B"
    },
    {
        "use_code": "75023",
        "facility_desc": "Miscellaneous Outdoor Recreation Facility",
        "naf_cat": "B"
    },
    {
        "use_code": "75030",
        "facility_desc": "Outdoor Swimming Pool",
        "naf_cat": "B"
    },
    {
        "use_code": "75033",
        "facility_desc": "Miscellaneous Outdoor Recreation Facility",
        "naf_cat": "B"
    },
    {
        "use_code": "75037",
        "facility_desc": "Miscellaneous Outdoor Recreation Facility",
        "naf_cat": "B"
    },
    {
        "use_code": "75038",
        "facility_desc": "Open Storage, Installation",
        "naf_cat": "B"
    },
    {
        "use_code": "75039",
        "facility_desc": "Vehicle Staging Area, Surfaced",
        "naf_cat": "C"
    },
    {
        "use_code": "75040",
        "facility_desc": "Golf Course",
        "naf_cat": "C"
    },
    {
        "use_code": "75050",
        "facility_desc": "Outdoor Theater",
        "naf_cat": "C"
    },
    {
        "use_code": "75052",
        "facility_desc": "Miscellaneous Outdoor Recreation Facility",
        "naf_cat": "C"
    },
    {
        "use_code": "75054",
        "facility_desc": "Pavilion",
        "naf_cat": "B"
    },
    {
        "use_code": "75056",
        "facility_desc": "Golf Driving Range",
        "naf_cat": "C"
    },
    {
        "use_code": "75057",
        "facility_desc": "Outdoor Recreation Area",
        "naf_cat": "A"
    },
    {
        "use_code": "75059",
        "facility_desc": "Recreational Camp and Trailer Park",
        "naf_cat": "C"
    },
    {
        "use_code": "75060",
        "facility_desc": "Marina",
        "naf_cat": "C"
    },
    {
        "use_code": "75061",
        "facility_desc": "Recreational Pier",
        "naf_cat": "C"
    },
    {
        "use_code": "75110",
        "facility_desc": "Playground",
        "naf_cat": "B"
    },
    {
        "use_code": "12310",
        "facility_desc": "Vehicle Fueling Facility",
        "naf_cat": "C"
    }
];


function goRPMHeaderCheck(Fac, Util, ICI) {
    
    const FacReq =  [
        "MCCS Installation Name",
        "iNFADS Facility #",
        "iNFADS Real Property Asset Name",
        "iNFADS Facility ID",
        "iNFADS Real Property Unique ID",
        "iNFADS Predominant Current Use Category Code",
        "iNFADS Current PRV",
        "iNFADS PRV EOY",
        "iNFADS Activity UIC",
        "iNFADS Area",
        "iNFADS Area Unit Measure Code",
        "iNFADS Facility Condition Index",
        "iNFADS FCI Date",
        "iNFADS Facility Built Date"
    ];
    
    const UtilReq = [
        "iNFADS Facility ID",
        "iNFADS Real Property Unique ID",
        "iNFADS Use Category Code",
        "iNFADS Facility Use",
        "iNFADS NAF Category",
        //"MCCS FY21 Restoration Cost",
        //"FSM FY21 Sustainment Cost",
        //"FSM FY22 Sustainment Cost",
        //"FSM FY23 Sustainment Cost",
        "iNFADS Adq Area Measure",
        //"iNFADS Sub Area Measure",
        //"iNFADS Iadq Area Measure",
        //"iNFADS Area Unit Meas"
    ];

    const ICIReq = [
        "iNFADS Facility ID",
        "iNFADS Real Property Unique ID",
        "iNFADS Use Category Code",
        "Visit Date",
        "Interior Condition Index for the facility"
    ];

//     for(i = 0; i<FacReq.length; i++) {
//          if(!Fac.includes(FacReq[i])) {
//             console.log(FacReq[i] + " not included");
//             return false;
//          }
//     }

//     for(i = 0; i<UtilReq.length; i++) {
//         if(!Util.includes(UtilReq[i])) {
//            console.log(UtilReq[i] + " not included");
//            return false;
//         }
//    }

//    for(i = 0; i<ICIReq.length; i++) {
//         if(!ICI.includes(ICIReq[i])) {
//         console.log(ICIReq[i]+ " not included");
//         return false;
//         }
//     }
    return true;
}

function goRPMProcess(Fac, Util, ICI) {
    var bar = document.getElementById("PB");
    var inflationinput = document.getElementById("inflationinput").value;
    var SelectedFY = document.getElementById("FYSelect").value;
    //init output arrays
    var FacOutput = [];
    var UtilOutput = [];
    var MCHSOutput = [];
    var ICIOutput = [];
    var susTag = "FSM FY" + SelectedFY + " Sustainment Cost";
    let currentDate = new Date();
    var currentYear = currentDate.getFullYear();
    var inflation  = Math.pow(inflationinput,(2000 + parseInt(SelectedFY) - parseInt(currentYear))); 
    var barInterval = 1/Fac.length;
    var barWidth = 0;
    //Process Facilities Sheet, rename headers
    for (i=0; i<Fac.length; i++) {
        //convert to workable installation/region names
        var Region, Installation;
        for(j = 0; j<InstNameConversionTable.length; j++) {
            if(InstNameConversionTable[j]["MCCS Installation Name"] == Fac[i]["MCCS Installation Name"]) {
                Region = InstNameConversionTable[j].Region;
                Installation = InstNameConversionTable[j].Installation;
            }
        }

        //Calc FCI Q-Ratings
        var fci_q
        if(Fac[i]["iNFADS Facility Condition Index"]>=90) {
            fci_q = "Q1";
        }
        else if(Fac[i]["iNFADS Facility Condition Index"]>=80) {
            fci_q = "Q2";
        }
        else if(Fac[i]["iNFADS Facility Condition Index"]>=60) {
            fci_q = "Q3";
        }
        else {
            fci_q = "Q4";
        }

        FacOutput.push({
            "region": Region, 
            "installation": Installation, 
            "RPUID": Fac[i]["iNFADS Real Property Unique ID"], 
            "fac_id": Fac[i]["iNFADS Facility ID"],
            "fac_num": Fac[i]["iNFADS Facility #"], 
            "asset_name": Fac[i]["iNFADS Real Property Asset Name"],
            "prv": parseFloat(Fac[i]["iNFADS Current PRV"] ?? 0),
            "fac_area_measure": Fac[i]["iNFADS Area"],
            "fac_area_unit_measure": Fac[i]["iNFADS Area Unit Measure Code"],
            "fci": Fac[i]["iNFADS Facility Condition Index"],
            "fci_q_rating": fci_q,
            "fci_dt": ExcelDateToJSDate(Fac[i]["iNFADS FCI Date"]),
            "build_dt": ExcelDateToJSDate(Fac[i]["iNFADS Facility Built Date"])
        });

        barWidth += (barInterval * 30);
        bar.style.width = barWidth + "%";

    }
    

    //Process Util, match Facility ID, have overall total number as well as sub arrays for multi utilizations for facilities for future use
    for (i=0; i<Util.length; i++) {
        var other_um= Util[i]["iNFADS Alt Unit Meas"];
        if(!Util[i]["iNFADS Alt Unit Meas"]) {
            other_um = Util[i]["iNFADS Other Unit Meas"];
        }

        //pull op activity from use code
        var ccn, op_activity, nafcat;
        ccn = Util[i]["iNFADS Use Category Code"].slice(0,5);
        for (j=0; j<CCNtoOpAct.length; j++) {
          if(ccn == CCNtoOpAct[j].use_code) {
            op_activity = CCNtoOpAct[j].op_activity;
          }
        }

        //NAF Category Conversion
        nafcat = Util[i]["iNFADS NAF Category"];
        if(nafcat == "N" || nafcat == null) {
            for (j=0; j<CCNNafCat.length; j++) {
                if(ccn == CCNNafCat[j].use_code) {
                    nafcat = CCNNafCat[j].naf_cat;
                }
                else {
                    nafcat = "C";
                }
            }            
        }

        if(ccn == 74094 || ccn == 74020) {
            for (j=0; j<CCNNafCat.length; j++) {
                if(ccn == CCNNafCat[j].use_code) {
                    nafcat = CCNNafCat[j].naf_cat;
                }
            }
        }

        //Match to Facilities and pull Region/Installation/FCI?/PRV
        var Region, Installation, FCI, PRV, FacArea, FacAreaUM, FacNum, AssetName;
        for (j=0; j<FacOutput.length; j++) {
            if(Util[i]["iNFADS Facility ID"] == FacOutput[j].fac_id) {
                Region = FacOutput[j].region;
                Installation = FacOutput[j].installation;
                FacNum = FacOutput[j].fac_num;
                AssetName = FacOutput[j].asset_name;
                FCI = FacOutput[j].fci;
                PRV = parseFloat(FacOutput[j].prv);
                FacArea = parseFloat(FacOutput[j].fac_area_measure);
                FacAreaUM = FacOutput[j].fac_area_unit_measure;
            }
        }

        var total_measure = parseFloat(Util[i]["iNFADS Adq Area Measure"] ?? 0) + parseFloat(Util[i]["iNFADS Sub Area Measure"] ?? 0) + parseFloat(Util[i]["iNFADS Iadq Area Measure"] ?? 0);
        var alt_total_measure = parseFloat(Util[i]["iNFADS Adq Alternate Measure"] ?? 0) + parseFloat(Util[i]["iNFADS Sub Alternate Measure"] ?? 0) + parseFloat(Util[i]["iNFADS Iadq Alternate Measure"] ?? 0);
        var other_total_measure = parseFloat(Util[i]["iNFADS Adq Other Measure"] ?? 0) + parseFloat(Util[i]["iNFADS Sub Other Measure"] ?? 0) + parseFloat(Util[i]["iNFADS Iadq Other Measure"] ?? 0);

        var rm = 0;
        if (FacArea > 0 && FacAreaUM == "SF") {
            rm = total_measure/FacArea*PRV*.025*inflation;
        }
        else {
            rm = PRV*.025*inflation;
        }

        var FSRM = Math.round(parseFloat(Util[i][susTag] ?? 0) + rm)

        //Checks following coloumns to ensure that these are MCCS utilizations, GoRPM does not accurately narrow down to MCCS acitivities
        var UAUIC = String(Util[i]["iNFADS User Activity UIC"]);
        var FacUse = String(Util[i]["iNFADS Facility Use"]);
        var iNFADSNafCat = String(Util[i]["iNFADS NAF Category"]);
        var CCNcombined = String(Util[i]["iNFADS Use Category Code"]);
        //|| iNFADSNafCat.includes("A" || "B" || "C")
        //|| CCNcombined.includes("EXCH")
        //UAUIC.includes("MCHS") && nafcat.includes("L")  || 
        if(FacUse.includes("EXCH" || "MCCS") || UAUIC.includes("MCCS") && !nafcat.includes("L")) {
            UtilOutput.push({
                "region": Region,
                "installation": Installation,
                "RPUID": Util[i]["iNFADS Real Property Unique ID"], 
                "fac_id": Util[i]["iNFADS Facility ID"],
                "fac_num": FacNum,
                "asset_name": AssetName,
                "use_code": Util[i]["iNFADS Use Category Code"].slice(0,5),
                "use_desc": Util[i]["iNFADS Use Category Code"].slice(6),
                "fac_use": Util[i]["iNFADS Facility Use"],
                "op_activity": op_activity,
                "facility_desc": Util[i]["iNFADS DoD FAC Code"].slice(5),
                "naf_cat": nafcat,
                "fci": FCI,
                "total_measure": parseFloat(Util[i]["iNFADS Adq Area Measure"] ?? 0) + parseFloat(Util[i]["iNFADS Sub Area Measure"] ?? 0) + parseFloat(Util[i]["iNFADS Iadq Area Measure"] ?? 0),
                "alt_total_measure": parseFloat(Util[i]["iNFADS Adq Alternate Measure"] ?? 0) + parseFloat(Util[i]["iNFADS Sub Alternate Measure"] ?? 0) + parseFloat(Util[i]["iNFADS Iadq Alternate Measure"] ?? 0),
                "other_total_measure": parseFloat(Util[i]["iNFADS Adq Other Measure"] ?? 0) + parseFloat(Util[i]["iNFADS Sub Other Measure"] ?? 0) + parseFloat(Util[i]["iNFADS Iadq Other Measure"] ?? 0),
                "other_unit_measure": other_um,
                "sus": Math.round(parseFloat(Util[i][susTag] ?? 0)),
                "RM_corrected": Math.round(rm),
                "FSRM": FSRM,
                "prv": Math.round(rm/inflation/0.025)
            });
        }
        if(UAUIC.includes("MCHS") && nafcat.includes("L")) {
            MCHSOutput.push({
                "region": Region,
                "installation": Installation,
                "RPUID": Util[i]["iNFADS Real Property Unique ID"], 
                "fac_id": Util[i]["iNFADS Facility ID"],
                "use_code": Util[i]["iNFADS Use Category Code"].slice(0,5),
                "use_desc": Util[i]["iNFADS Use Category Code"].slice(6),
                "fac_use": Util[i]["iNFADS Facility Use"],
                "op_activity": op_activity,
                "facility_desc": Util[i]["iNFADS DoD FAC Code"].slice(5),
                "naf_cat": nafcat,
                "fci": FCI,
                "total_measure": parseFloat(Util[i]["iNFADS Adq Area Measure"] ?? 0) + parseFloat(Util[i]["iNFADS Sub Area Measure"] ?? 0) + parseFloat(Util[i]["iNFADS Iadq Area Measure"] ?? 0),
                "alt_total_measure": parseFloat(Util[i]["iNFADS Adq Alternate Measure"] ?? 0) + parseFloat(Util[i]["iNFADS Sub Alternate Measure"] ?? 0) + parseFloat(Util[i]["iNFADS Iadq Alternate Measure"] ?? 0),
                "other_total_measure": parseFloat(Util[i]["iNFADS Adq Other Measure"] ?? 0) + parseFloat(Util[i]["iNFADS Sub Other Measure"] ?? 0) + parseFloat(Util[i]["iNFADS Iadq Other Measure"] ?? 0),
                "other_unit_measure": other_um,
                "sus": parseFloat(Util[i][susTag] ?? 0),
                "RM_corrected": rm
            });
        }
    }
    //ICIs
    //Array joins

    var df_final = [];
    var total_utils = 0;
    for (i=0; i<FacOutput.length; i++) {
        var FacilityID = FacOutput[i].fac_id;
        var naf_cat_array = [];
        var total_measure_sum = 0;
        var alt_total_measure_sum = 0;
        var other_total_measure_sum = 0;
        var sus_sum = 0;
        var rm_calc = 0;
        var facility_utilizations = [];
        var facility_utilizations_count = 0;

        for (j = 0; j<UtilOutput.length; j++) {
            if (UtilOutput[j].fac_id == FacilityID) {
                naf_cat_array.push(UtilOutput[j].naf_cat);
                total_measure_sum += parseFloat(UtilOutput[j].total_measure ?? 0);
                alt_total_measure_sum += UtilOutput[j].alt_total_measure;
                other_total_measure_sum += UtilOutput[j].other_total_measure;
                sus_sum += UtilOutput[j].sus;
                //rm_sum += UtilOutput[j].RM_corrected;
                if(parseFloat(FacOutput[i].fac_area_measure ?? 0) > 0){
                  rm_calc += FacOutput[i].prv*.025*parseFloat(UtilOutput[j].total_measure ?? 0)/parseFloat(FacOutput[i].fac_area_measure ?? 1);
                }
                else {
                  rm_calc += FacOutput[i].prv*.025;
                }
                facility_utilizations.push(UtilOutput[j]);
                facility_utilizations_count++;
                total_utils++;
            }
        }

        var naf_cat = [...new Set(naf_cat_array)];
        naf_cat_array.sort();

        if(facility_utilizations_count>0) {
        df_final.push({...FacOutput[i], 
          "total_measure":total_measure_sum, 
          "alt_total_measure":alt_total_measure_sum, 
          "other_total_measure":other_total_measure_sum, 
          "naf_cat": naf_cat_array[0], 
          "naf_cat_types": naf_cat.length,
          "naf_cat_array": naf_cat_array, 
          "sus": sus_sum, 
          "RM_corrected": rm_calc*inflation,
          "Utilization_count": facility_utilizations_count, 
          "Utilizations": facility_utilizations});
        }
    }
    console.log(df_final.length);
    console.log(UtilOutput.length);
    return [df_final, UtilOutput, MCHSOutput];

    function ExcelDateToJSDate(serial) {
        var utc_days  = Math.floor(serial - 25569);
        var utc_value = utc_days * 86400;                                        
        var date_info = new Date(utc_value * 1000);
        return new Date(date_info.getFullYear(), date_info.getMonth(), date_info.getDate());
     }
}


//=========================================== Utilization vs Profitability ==========================================

function processUtilProf (data) {
  //Separate by Cost Center Code
  //map CC
  var CostCenterDesc = [];
  CostCenterDesc.push(...new Set(data.map(item => item["Cost Center Description"])));

  var output = [];
  for(i=0; i<CostCenterDesc.length; i++) {
    var subarray = [];
    var Cost_Center = "";
    for(j=0; j<data.length; j++) {
      if(data[j]["Cost Center Description"] === CostCenterDesc[i]) {
        Cost_Center = data[j].Cost_Center;
        subarray.push({"Company": data[j].Company, "ADUtilPercent": data[j].ADUtilPercent, "ProfPercentage": data[j].ProfPercentage});
      }
    }
    output.push({"Cost_Center": Cost_Center, "CCDesc": CostCenterDesc[i], "UtilProfData": subarray});
  }

  let ct = document.getElementById("UtilProfContainer");

  let html = "<h1 style='padding-top: 20px; text-align:center;'>MCCS Profit vs Utilization</h1>"
  output.forEach(e => {
    html += "<div class='" + e.Cost_Center + "' style='padding-top:10px'><h3>" + e.Cost_Center + " " + e.CCDesc + "</h3>" 
    + "<canvas id='" + e.Cost_Center + "'></canvas>"
    + "<table id='" + e.Cost_Center + "table'>"
    +"<thead><tr><th>Company</th><th>Percent Use by Active Duty</th><th>Percent Net Profit</th></tr></thead></table>"
    + "<hr></div>";
  });
  ct.innerHTML = html;

  

  output.forEach(e => {
    //create Chart
    const ctx = document.getElementById(e.Cost_Center);
    var data = e.UtilProfData;

    var input = [];

    data.forEach(element => {
      input.push({'label': element.Company, 'data': [{"x": parseFloat(element.ADUtilPercent), "y": parseFloat(element.ProfPercentage)}]})
    })

    new Chart(ctx, {
      type: 'scatter',
      data: {
        datasets: input
      },
      options: {
        scales: {
          x: {
            beginAtZero: true
          }
        }
      }
    });

    //create Table
    var reference = '#' + e.Cost_Center + 'table';
    $(document).ready(function () {
      $(reference).dataTable({
          data: data,
          dom: "Bfrtip",
          buttons: ['copy', 'csv', 'excel'],
          paging: false,
          order: [[2, 'desc']],
          "bLengthChange": false,
          "bFilter": false,
          "bInfo": false,
          columns: [
              {data: 'Company'},
              {data: 'ADUtilPercent',render: $.fn.dataTable.render.number(',', '.', 2, '', '%' )},
              {data: 'ProfPercentage',render: $.fn.dataTable.render.number(',', '.', 2, '', '%' )}
          ]
        });
      });
  });
}